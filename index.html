<!DOCTYPE html>
<html lang="pl" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <!-- PWA & macOS Integration -->
        <title>Kora · Cortex</title>
        <meta name="description" content="Profesjonalny system synchronizacji półkul mózgowych." />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Kora Cortex">
        <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/22d3ee/brain.png">

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Tone.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet" />

        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                            mono: ['JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        },
                        colors: {
                            zinc: {
                                850: '#1f1f22',
                                925: '#101012',
                            },
                            medical: {
                                400: '#22d3ee', // Cyan-400 (Glow)
                                500: '#06b6d4', // Cyan-500 (Solid)
                                900: '#164e63', // Dark bg
                            }
                        },
                        backgroundImage: {
                            'grid-pattern': "linear-gradient(to right, #27272a 1px, transparent 1px), linear-gradient(to bottom, #27272a 1px, transparent 1px)",
                        },
                        animation: {
                            'breath-grid': 'breathGrid 8s ease-in-out infinite',
                            'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
                            'glitch': 'glitch 1s linear infinite',
                            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        },
                        keyframes: {
                            breathGrid: {
                                '0%, 100%': { opacity: '0.1' },
                                '50%': { opacity: '0.2' },
                            },
                            fadeInUp: {
                                '0%': { opacity: '0', transform: 'translateY(20px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            },
                            glitch: {
                                '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                                '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                                '62%': { transform: 'translate(0,0) skew(5deg)' },
                            }
                        }
                    }
                }
            }
        </script>

        <style>
            :root {
                --bg-dark: #050505;
                --panel-bg: rgba(15, 15, 18, 0.85);
                --cyan-glow: rgba(34, 211, 238, 0.4);
            }

            body {
                background-color: var(--bg-dark);
                color: #e4e4e7;
                -webkit-font-smoothing: antialiased;
                overflow-x: hidden;
            }

            .doc-scroll::-webkit-scrollbar { width: 8px; }
            .doc-scroll::-webkit-scrollbar-track { background: #09090b; }
            .doc-scroll::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
            .doc-scroll::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

            .bg-grid {
                background-size: 50px 50px;
                mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 90%);
                -webkit-mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 90%);
                position: fixed;
                inset: 0;
                pointer-events: none;
                z-index: -1;
                border-top: 1px solid rgba(255,255,255,0.05);
            }

            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

            #visualizer:fullscreen, #visualizer:-webkit-full-screen {
                width: 100vw !important;
                height: 100vh !important;
                border-radius: 0 !important;
                border: none !important;
                background-color: #000 !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #visualizer:fullscreen canvas, #visualizer:-webkit-full-screen canvas {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain;
            }

            .glass-panel {
                background: var(--panel-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
                transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 1s ease;
            }

            .glass-panel:hover {
                border-color: rgba(34, 211, 238, 0.3);
                box-shadow: 0 12px 40px 0 rgba(34, 211, 238, 0.1);
            }

            .glow-text-cyan { text-shadow: 0 0 15px var(--cyan-glow); color: #22d3ee; }
            .glow-box-cyan {
                box-shadow: 0 0 15px var(--cyan-glow), inset 0 0 10px rgba(34, 211, 238, 0.1);
                border-color: rgba(34, 211, 238, 0.5);
            }

            .scanline {
                width: 100%;
                height: 100%;
                z-index: 10;
                background: linear-gradient(0deg, rgba(0,0,0,0) 50%, rgba(34, 211, 238, 0.02) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
                background-size: 100% 2px, 3px 100%;
                pointer-events: none;
            }

            .science-table {
                width: 100%; border-collapse: collapse; font-size: 0.75rem; margin: 1rem 0;
            }
            .science-table th {
                text-align: left; padding: 0.75rem; border-bottom: 1px solid #3f3f46; color: #22d3ee; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;
            }
            .science-table td { padding: 0.75rem; border-bottom: 1px solid #27272a; color: #d4d4d8; }
            .science-table tr:last-child td { border-bottom: none; }

            .landing-glitch:hover {
                animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
                color: #22d3ee;
            }

            .terminal-log {
                font-family: 'JetBrains Mono', monospace;
                mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            }

            .dimmed-ui {
                opacity: 0.15;
                transition: opacity 1s ease;
            }
            .dimmed-ui:hover {
                opacity: 1;
            }
        </style>
    </head>
    <body class="min-h-screen flex flex-col selection:bg-medical-400 selection:text-black font-sans overflow-x-hidden">

        <div class="bg-grid bg-grid-pattern animate-breath-grid"></div>

        <!-- BACKGROUND AUDIO HELPER (For Mobile Lock Screen) -->
        <audio id="silentAudioLoop" loop style="display:none;">
            <source src="data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
        </audio>

        <!-- LANDING PAGE (ACCESS GATE) -->
        <section id="landingPage" class="fixed inset-0 z-[200] bg-zinc-950 overflow-y-auto overflow-x-hidden transition-all duration-1000">
            <div class="min-h-full flex flex-col items-center justify-center p-6 py-24 relative">

                <div id="landingGlow" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-medical-400/5 rounded-full blur-[100px] pointer-events-none transition-transform duration-100 ease-out"></div>

                <div class="absolute top-10 left-10 w-64 h-96 opacity-20 pointer-events-none hidden lg:block terminal-log text-[10px] text-medical-400 space-y-1">
                    <div>> SYSTEM_BOOT_SEQUENCE_INIT</div>
                    <div>> CHECKING_NEURAL_INTERFACES... OK</div>
                    <div>> LOADING_WAVEFORM_LIBRARIES... OK</div>
                    <div>> CALIBRATING_OSCILLATORS_L/R... OK</div>
                    <div>> ESTABLISHING_SECURE_Handshake... OK</div>
                    <div>> USER_BIO_METRICS... PENDING</div>
                    <div>> AWAITING_INPUT...</div>
                </div>

                <div class="max-w-5xl w-full space-y-16 relative z-10">

                    <div class="text-center space-y-6 animate-fade-in-up" style="animation-delay: 0.1s;">
                        <div class="inline-flex items-center gap-3 border border-zinc-800 rounded-full px-4 py-1.5 bg-zinc-900/80 backdrop-blur mb-6 hover:border-medical-400/50 transition-colors cursor-default">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-medical-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-medical-500"></span>
                            </span>
                            <span class="text-[10px] font-mono text-zinc-400 uppercase tracking-widest">System Online v2.7</span>
                        </div>

                        <h1 class="text-6xl md:text-8xl font-bold tracking-tight text-white select-none">
                            <span class="block landing-glitch transition-colors duration-300">Kora Cortex</span>
                            <span class="text-2xl md:text-3xl font-light text-zinc-500 tracking-[0.2em] mt-4 block font-mono">NEURAL ENTRAINMENT</span>
                        </h1>

                        <p class="text-sm md:text-base text-zinc-400 max-w-2xl mx-auto font-light leading-relaxed">
                            Zaawansowana platforma bio-hackingu. Wykorzystaj <span class="text-zinc-200">Binaural Beats</span>, <span class="text-zinc-200">Isochronic Tones</span> oraz <span class="text-zinc-200">Stochastyczny Rezonans</span> do precyzyjnej modulacji stanów świadomości.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in-up" style="animation-delay: 0.3s;">
                        <div class="glass-panel p-8 rounded-2xl border-t border-zinc-700/50 group cursor-default">
                            <div class="w-10 h-10 rounded-lg bg-zinc-900 flex items-center justify-center mb-6 group-hover:bg-medical-900/30 transition-colors border border-zinc-800 group-hover:border-medical-400/30">
                                <svg class="text-zinc-400 group-hover:text-medical-400 transition-colors" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                            </div>
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3 group-hover:text-medical-400 transition-colors">Głęboka Praca</h3>
                            <p class="text-xs text-zinc-500 leading-relaxed">
                                Protokoły Beta (14-30Hz) i Gamma (40Hz) optymalizują przetwarzanie informacji, wspierając logiczne myślenie i neuroprotekcję.
                            </p>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl border-t border-zinc-700/50 group cursor-default">
                            <div class="w-10 h-10 rounded-lg bg-zinc-900 flex items-center justify-center mb-6 group-hover:bg-medical-900/30 transition-colors border border-zinc-800 group-hover:border-medical-400/30">
                                <svg class="text-zinc-400 group-hover:text-medical-400 transition-colors" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3 group-hover:text-medical-400 transition-colors">Baza Wiedzy</h3>
                            <p class="text-xs text-zinc-500 leading-relaxed">
                                Dostęp do pełnego raportu badawczego. Mechanizmy FFR, protokoły Harding FPA i analiza wpływu na układ glimfatyczny.
                            </p>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl border-t border-zinc-700/50 group cursor-default">
                            <div class="w-10 h-10 rounded-lg bg-zinc-900 flex items-center justify-center mb-6 group-hover:bg-medical-900/30 transition-colors border border-zinc-800 group-hover:border-medical-400/30">
                                <svg class="text-zinc-400 group-hover:text-medical-400 transition-colors" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.354 15.354A9 9 0 0 1 8.646 3.646 9.003 9.003 0 0 0 12 21a9.003 9.003 0 0 0 8.354-5.646z"></path></svg>
                            </div>
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3 group-hover:text-medical-400 transition-colors">Regeneracja</h3>
                            <p class="text-xs text-zinc-500 leading-relaxed">
                                Fale Delta (0.5-4Hz) i Szum Różowy wspomagają głęboki sen NREM i fizjologiczne oczyszczanie mózgu z toksyn.
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-6 animate-fade-in-up" style="animation-delay: 0.5s;">
                        <button id="enterSystemBtn" class="group relative inline-flex items-center justify-center px-12 py-5 font-mono font-bold text-black transition-all duration-300 bg-white text-sm rounded-sm uppercase tracking-[0.2em] hover:bg-medical-400 hover:scale-105 hover:shadow-[0_0_30px_rgba(34,211,238,0.6)] focus:outline-none">
                            <span class="mr-2">Inicjuj System</span>
                            <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            <span class="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-black group-hover:border-white transition-colors"></span>
                            <span class="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-black group-hover:border-white transition-colors"></span>
                        </button>
                        <p class="text-[10px] text-zinc-600 font-mono uppercase flex items-center gap-2">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                            Wymagane słuchawki stereo
                        </p>
                    </div>
                </div>

                <div class="fixed bottom-0 inset-x-0 p-4 flex justify-between items-end text-[9px] font-mono text-zinc-700 uppercase tracking-widest opacity-50 select-none pointer-events-none z-20 bg-gradient-to-t from-zinc-950 to-transparent">
                    <div class="hidden md:block">SECURE CONNECTION<br>TLS 1.3 / AES-256</div>
                    <div class="text-right">LATENCY: 14ms<br>CORE: STABLE</div>
                </div>
            </div>
        </section>

        <!-- CALIBRATION OVERLAY -->
        <div id="calibrationOverlay" class="fixed inset-0 z-[100] bg-black hidden flex-col items-center justify-center transition-opacity duration-1000">
            <div class="w-64 space-y-4">
                <div class="flex justify-between text-[10px] font-mono text-medical-400 uppercase tracking-widest">
                    <span>System Check</span>
                    <span id="calibPercent">0%</span>
                </div>
                <div class="h-[2px] w-full bg-zinc-900 overflow-hidden">
                    <div id="calibBar" class="h-full bg-medical-400 w-0 shadow-[0_0_10px_rgba(34,211,238,0.8)] transition-all duration-300 ease-out"></div>
                </div>
                <div class="text-[10px] font-mono text-zinc-500 h-4" id="calibText">Initializing Neural Engine...</div>
            </div>
        </div>

        <!-- APP CONTAINER (Hidden initially) -->
        <div id="appInterface" class="opacity-0 transition-opacity duration-1000 hidden">
            <header id="appHeader" class="fixed inset-x-0 top-0 z-50 border-b border-white/5 bg-black/80 backdrop-blur-md h-14 transition-opacity duration-1000">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 h-full flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-default">
                        <div class="w-8 h-8 rounded bg-zinc-900 flex items-center justify-center border border-white/10 relative overflow-hidden group">
                            <div class="absolute inset-0 bg-medical-400/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <span class="font-mono text-xs font-bold tracking-tighter text-medical-400">KΩ</span>
                        </div>
                        <div class="flex flex-col justify-center h-full pt-1">
                            <span class="text-[10px] font-bold tracking-[0.25em] uppercase text-zinc-200 leading-none">Cortex</span>
                            <span class="text-[9px] text-zinc-600 uppercase tracking-wider leading-tight mt-0.5">Bio-Entrainment v2.7</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button id="guideToggle" class="hidden sm:flex items-center gap-2 text-[10px] uppercase tracking-wider text-zinc-400 hover:text-white transition-colors border border-zinc-800 rounded px-3 py-1 hover:border-medical-400/50">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                            <span>Raport</span>
                        </button>
                        <button id="programToggle" class="hidden sm:flex items-center gap-2 text-[10px] uppercase tracking-wider text-zinc-400 hover:text-white transition-colors border border-zinc-800 rounded px-3 py-1 hover:border-medical-400/50">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l9.5 5.5-9.5 5.5L2.5 8.5 12 3z"></path><path d="M2.5 15.5 12 21l9.5-5.5"></path><path d="m2.5 12 9.5 5.5 9.5-5.5"></path></svg>
                            <span>Programy</span>
                        </button>
                        <button id="safetyToggle" class="hidden sm:flex items-center gap-2 text-[10px] uppercase tracking-wider text-zinc-400 hover:text-white transition-colors border border-zinc-800 rounded px-3 py-1 hover:border-medical-400/50">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            <span>Bezpieczeństwo</span>
                        </button>
                        <div class="hidden sm:flex items-center gap-3 px-3 py-1.5 rounded-full bg-zinc-925 border border-zinc-800/60">
                            <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-zinc-600 transition-colors duration-500"></div>
                            <span id="statusText" class="text-[9px] font-mono text-zinc-500 uppercase tracking-widest w-16 text-center">Standby</span>
                        </div>
                        <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-zinc-925 border border-zinc-800/60 text-[9px] font-mono text-zinc-500 uppercase tracking-widest">
                            <span class="w-2 h-2 rounded-full bg-medical-900/70"></span>
                            <span id="programStatus">Brak aktywnego programu</span>
                        </div>
                        <button id="settingsToggle" class="p-2 text-zinc-400 hover:text-medical-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                        </button>
                    </div>
                </div>
            </header>

            <main class="min-h-screen pt-20 pb-40 px-4 sm:px-6 relative z-10 flex flex-col items-center">
                <div class="max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow lg:min-h-[600px] lg:h-auto h-auto">
                    <div id="leftPanel" class="lg:col-span-4 flex flex-col gap-4 order-2 lg:order-1 h-full transition-opacity duration-1000">

                        <section id="circadianWidget" class="glass-panel rounded-xl p-4 shrink-0 border-l-2 border-medical-400 flex items-center justify-between group cursor-pointer hover:bg-medical-900/20 transition-colors">
                            <div>
                                <span class="text-[9px] text-zinc-500 font-bold uppercase tracking-widest block mb-1">Circadian Sync</span>
                                <h3 id="circadianTitle" class="text-sm text-white font-mono">Analiza...</h3>
                            </div>
                            <div class="h-8 w-8 rounded-full bg-medical-900/50 flex items-center justify-center text-medical-400 group-hover:text-white transition-colors">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </div>
                        </section>

                        <section class="glass-panel rounded-xl p-1 flex flex-col flex-1 min-h-[300px]">
                            <div class="px-4 py-3 border-b border-white/5 flex justify-between items-center shrink-0">
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Wybierz Protokół</span>
                                <span class="text-[9px] font-mono text-zinc-600">9 DOSTĘPNYCH</span>
                            </div>
                            <div class="overflow-y-auto flex-1 p-1 space-y-1 custom-scroll" id="modeContainer"></div>
                        </section>

                        <section class="glass-panel rounded-xl p-4 space-y-3 relative overflow-hidden shrink-0">
                            <div class="absolute -right-10 -bottom-10 w-24 h-24 bg-medical-400/5 rounded-full blur-2xl"></div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Programy</h2>
                                    <p class="text-xs text-zinc-400">Sekwencje kilku protokołów z pauzą między krokami.</p>
                                </div>
                                <span id="programStatus" class="text-[10px] font-mono text-zinc-500">Brak aktywnego programu</span>
                            </div>
                            <div id="programList" class="space-y-3"></div>
                        </section>

                        <section class="glass-panel rounded-xl p-5 space-y-4 relative overflow-hidden shrink-0">
                            <div class="absolute -right-10 -bottom-10 w-32 h-32 bg-medical-400/5 rounded-full blur-2xl"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-[9px] uppercase text-zinc-600 font-bold tracking-wider block mb-1">Dudnienie</span>
                                    <span id="realtimeHz" class="text-sm font-mono text-medical-400 transition-all duration-300">-- Hz</span>
                                </div>
                                <div>
                                    <span class="text-[9px] uppercase text-zinc-600 font-bold tracking-wider block mb-1">Tło</span>
                                    <span id="noiseTypeDisplay" class="text-xs font-mono text-zinc-400">Brown Noise</span>
                                </div>
                            </div>
                            <div class="pt-2 flex items-center justify-between">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <div class="relative">
                                        <input id="focusLockToggle" type="checkbox" class="sr-only peer">
                                        <div class="w-8 h-4 bg-zinc-800 rounded-full peer peer-focus:ring-1 peer-focus:ring-medical-400/30 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:border-zinc-400 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-medical-900 peer-checked:after:bg-medical-400"></div>
                                    </div>
                                    <span class="text-[10px] text-zinc-500 uppercase tracking-wider group-hover:text-zinc-300 transition-colors">Focus Lock</span>
                                </label>
                                <span class="text-[9px] text-zinc-700 font-mono">ESC aby przerwać</span>
                            </div>
                        </section>

                        <!-- Hypnos duration selection (visible only for Hypnos mode) -->
                        <section id="hypnosDurationCard" class="glass-panel rounded-xl p-5 space-y-3 relative overflow-hidden shrink-0 hidden">
                            <div class="absolute -right-10 -bottom-10 w-24 h-24 bg-medical-400/5 rounded-full blur-2xl"></div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-1">Hypnos · Czas</h2>
                                    <p class="text-xs text-zinc-400">Wybierz długość sesji i zachowaj w pamięci.</p>
                                </div>
                                <span class="text-[9px] text-medical-400 font-mono">Auto-stop</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2" id="hypnosDurationButtons">
                                <button data-duration="30" class="w-full py-2 text-xs rounded border border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:border-medical-400/40 transition-all">30 min</button>
                                <button data-duration="45" class="w-full py-2 text-xs rounded border border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:border-medical-400/40 transition-all">45 min</button>
                                <button data-duration="90" class="w-full py-2 text-xs rounded border border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:border-medical-400/40 transition-all">90 min</button>
                                <button data-duration="infinity" class="w-full py-2 text-xs rounded border border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:border-medical-400/40 transition-all">∞ noc</button>
                            </div>
                        </section>
                    </div>

                    <div class="lg:col-span-8 flex flex-col gap-4 order-1 lg:order-2 h-full">
                        <div id="visualizer" class="relative w-full flex-1 min-h-[300px] rounded-2xl bg-black overflow-hidden border border-zinc-800 shadow-2xl group ring-1 ring-white/5 aspect-square sm:aspect-video lg:aspect-auto">
                            <div class="scanline absolute inset-0 pointer-events-none"></div>
                            <canvas id="visualCanvas" class="absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000"></canvas>

                            <div id="message-box" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-black/40 backdrop-blur-sm transition-all duration-700">
                                <div class="w-14 h-14 mb-5 rounded-full border border-zinc-800 flex items-center justify-center relative group-hover:border-medical-400/30 transition-colors duration-500">
                                    <div class="absolute inset-0 border border-medical-400/20 rounded-full animate-ping opacity-20"></div>
                                    <svg class="w-6 h-6 text-zinc-500 group-hover:text-medical-400 transition-colors duration-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25">
                                        <circle cx="12" cy="12" r="7" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.5v4.75" />
                                        <circle cx="12" cy="16.5" r="0.65" fill="currentColor" />
                                    </svg>
                                </div>
                                <div class="space-y-2 max-w-xl">
                                    <h1 id="messageTitle" class="text-2xl font-light text-white tracking-tight">Kora <span class="font-bold text-medical-400">Cortex</span></h1>
                                    <p id="modeDesc" class="text-sm text-zinc-300 leading-relaxed font-light">System gotowy. Wymagane słuchawki stereo.</p>
                                </div>
                            </div>

                            <div id="programOverlay" class="absolute inset-0 hidden flex items-center justify-center p-4 z-30">
                                <div class="glass-panel rounded-xl border border-medical-400/20 bg-black/70 max-w-xl w-full p-6 space-y-4">
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full bg-medical-900/60 border border-medical-500/50 flex items-center justify-center text-medical-400">
                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14" stroke-linecap="round" /></svg>
                                        </div>
                                        <div class="space-y-1">
                                            <p id="programOverlayLabel" class="text-[11px] font-mono uppercase tracking-[0.2em] text-medical-400">Program</p>
                                            <h3 id="programOverlayTitle" class="text-lg font-semibold text-white">Następny etap programu</h3>
                                            <p id="programOverlayBody" class="text-sm text-zinc-300 leading-relaxed"></p>
                                        </div>
                                    </div>
                                    <div class="bg-zinc-900/40 border border-zinc-800 rounded-lg p-3">
                                        <div id="programOverlayStep" class="text-sm text-white font-medium"></div>
                                        <p id="programOverlayStepMeta" class="text-xs text-zinc-400"></p>
                                    </div>
                                    <div class="flex flex-wrap gap-2 justify-end">
                                        <button id="programEndBtn" class="px-3 py-2 text-xs uppercase tracking-wider border border-zinc-700 rounded text-zinc-300 hover:text-white hover:border-red-400/70 transition-colors">Zakończ program</button>
                                        <button id="programContinueBtn" class="px-3 py-2 text-xs uppercase tracking-wider bg-medical-400 text-black rounded shadow-[0_0_14px_rgba(34,211,238,0.35)] hover:shadow-[0_0_18px_rgba(34,211,238,0.55)] transition-all">Start kolejnego etapu</button>
                                    </div>
                                </div>
                            </div>

                            <div class="absolute top-4 right-4 z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <button id="fullscreenButton" class="p-2 rounded bg-black/60 hover:bg-zinc-800 text-zinc-400 hover:text-medical-400 border border-zinc-700 backdrop-blur transition-all">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                                </button>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-[3px] bg-zinc-900 z-20">
                                <div id="progressBar" class="h-full bg-medical-400 shadow-[0_0_15px_rgba(34,211,238,0.8)] w-0 transition-all duration-300 ease-linear"></div>
                            </div>
                        </div>

                        <div id="controlPanel" class="glass-panel rounded-2xl px-6 py-4 flex items-center justify-between gap-6 shrink-0 h-auto sm:h-24 flex-wrap sm:flex-nowrap transition-all duration-1000">
                            <div class="flex flex-col justify-center min-w-[100px]">
                                <div id="timer" class="font-mono text-4xl text-white tracking-tighter tabular-nums transition-all duration-300">00:00</div>
                            </div>
                            <div class="hidden md:flex flex-col items-start px-6 border-l border-zinc-800/50 flex-1">
                                <span class="text-[9px] uppercase text-zinc-600 font-bold tracking-widest mb-1">Aktualna Faza</span>
                                <span id="currentPhaseName" class="text-sm text-zinc-300 truncate">Oczekiwanie na start</span>
                            </div>
                            <div class="flex items-center gap-3 w-full sm:w-auto mt-2 sm:mt-0">
                                <button id="previewButton" class="hidden sm:block px-5 py-3 rounded border border-zinc-700 text-[10px] font-bold uppercase tracking-wider text-zinc-400 hover:text-white hover:bg-zinc-800 transition-all">
                                    Test Wizualny
                                </button>
                                <button id="mainActionBtn" class="flex-1 sm:flex-none px-8 py-3 rounded bg-zinc-100 hover:bg-white active:scale-95 text-black text-xs font-bold uppercase tracking-widest transition-all shadow-[0_0_20px_rgba(255,255,255,0.05)] min-w-[120px]">
                                    Uruchom
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <footer id="appFooter" class="w-full px-4 relative z-0 mt-24 transition-opacity duration-1000">
                    <div class="border-t border-zinc-900 pt-6 pb-12 text-center backdrop-blur-sm">
                        <p class="text-[9px] text-zinc-600 uppercase tracking-widest max-w-2xl mx-auto leading-relaxed">Sprawdź zakładkę „Bezpieczeństwo” w górnym menu, aby poznać pełne wytyczne korzystania.</p>
                    </div>
                </footer>
            </main>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur hidden items-center justify-center p-4">
            <div class="bg-zinc-900 border border-zinc-700 rounded-lg w-full max-w-sm p-6 shadow-2xl relative">
                <button id="closeSettings" class="absolute top-4 right-4 text-zinc-500 hover:text-white">✕</button>
                <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-6 border-b border-zinc-800 pb-2">Konfiguracja</h3>

                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest block mb-3">Asystent</label>
                        <label class="flex items-center gap-3 cursor-pointer group p-3 border border-zinc-800 bg-zinc-900/50 rounded-lg hover:border-zinc-700 transition-colors">
                            <div class="relative">
                                <input id="breathToggle" type="checkbox" class="sr-only peer">
                                <div class="w-8 h-4 bg-zinc-800 rounded-full peer peer-focus:ring-1 peer-focus:ring-medical-400/30 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:border-zinc-400 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-medical-900 peer-checked:after:bg-medical-400"></div>
                            </div>
                            <div>
                                <span class="block text-xs text-zinc-200 group-hover:text-white transition-colors">Asystent Oddechu</span>
                                <span id="breathPatternSummary" class="block text-[9px] text-zinc-500 mt-0.5">Rytm 4s/6s lub automatyczny wg protokołu.</span>
                            </div>
                        </label>

                        <div class="mt-3">
                            <label class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest block mb-2">Styl oddechu</label>
                            <div class="grid grid-cols-2 gap-2" id="breathPatternButtons">
                                <button data-pattern="auto" class="breath-pattern-btn py-2 border border-zinc-700 bg-zinc-800 rounded text-[11px] text-zinc-300 hover:text-white transition-all">Auto (wg trybu)</button>
                                <button data-pattern="4-6" class="breath-pattern-btn py-2 border border-zinc-700 bg-zinc-800 rounded text-[11px] text-zinc-300 hover:text-white transition-all">4–6</button>
                                <button data-pattern="4-7-8" class="breath-pattern-btn py-2 border border-zinc-700 bg-zinc-800 rounded text-[11px] text-zinc-300 hover:text-white transition-all">4–7–8</button>
                                <button data-pattern="box" class="breath-pattern-btn py-2 border border-zinc-700 bg-zinc-800 rounded text-[11px] text-zinc-300 hover:text-white transition-all">Box 4–4–4–4</button>
                            </div>
                            <p id="breathPatternHelper" class="text-[10px] text-zinc-500 mt-2">Auto dopasuje wzorzec do wybranego trybu.</p>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest block mb-3">Kolor Szumu (Tło)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="setPinkNoise" class="noise-btn py-3 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:text-white transition-all active-noise">Różowy</button>
                            <button id="setBrownNoise" class="noise-btn py-3 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:text-white transition-all">Brązowy</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 cursor-pointer group p-3 border border-zinc-800 bg-zinc-900/50 rounded-lg hover:border-zinc-700 transition-colors">
                            <div class="relative">
                                <input id="safeVisualsToggle" type="checkbox" class="sr-only peer">
                                <div class="w-8 h-4 bg-zinc-800 rounded-full peer peer-focus:ring-1 peer-focus:ring-medical-400/30 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:border-zinc-400 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-medical-900 peer-checked:after:bg-medical-400"></div>
                            </div>
                            <div>
                                <span class="block text-xs text-zinc-200 group-hover:text-white transition-colors">Safe Visuals</span>
                                <span class="block text-[9px] text-zinc-500 mt-0.5">Ogranicz migotanie i kontrast.</span>
                            </div>
                        </label>

                        <label class="flex items-center gap-3 cursor-pointer group p-3 border border-zinc-800 bg-zinc-900/50 rounded-lg hover:border-zinc-700 transition-colors">
                            <div class="relative">
                                <input id="audioOnlyToggle" type="checkbox" class="sr-only peer">
                                <div class="w-8 h-4 bg-zinc-800 rounded-full peer peer-focus:ring-1 peer-focus:ring-medical-400/30 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-500 after:border-zinc-400 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-medical-900 peer-checked:after:bg-medical-400"></div>
                            </div>
                            <div>
                                <span class="block text-xs text-zinc-200 group-hover:text-white transition-colors">Tryb Tylko Audio</span>
                                <span class="block text-[9px] text-zinc-500 mt-0.5">Statyczne tło bez animacji.</span>
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest block mb-3">Poziom Intensywności</label>
                        <div class="grid grid-cols-3 gap-3" id="intensityButtons">
                            <button data-intensity="low" class="intensity-btn py-3 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:text-white transition-all">Low</button>
                            <button data-intensity="medium" class="intensity-btn py-3 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:text-white transition-all">Medium</button>
                            <button data-intensity="high" class="intensity-btn py-3 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:text-white transition-all">High</button>
                        </div>
                        <p class="text-[10px] text-zinc-500 mt-2">Skaluje głośność kanałów L/R i separację częstotliwości.</p>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest block mb-3">Kalibracja Audio</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="testLeftButton" class="py-2 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:bg-zinc-700 transition-colors">Lewy</button>
                            <button id="testRightButton" class="py-2 border border-zinc-700 bg-zinc-800 rounded text-xs text-zinc-300 hover:bg-zinc-700 transition-colors">Prawy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GUIDE MODAL -->
        <div id="guideModal" class="fixed inset-0 z-[70] bg-black/95 backdrop-blur-sm hidden items-center justify-center p-4 sm:p-8">
            <div class="bg-zinc-950 border border-zinc-800 rounded-xl w-full max-w-5xl h-full max-h-[90vh] shadow-2xl relative flex flex-col ring-1 ring-white/10">
                <div class="flex items-center justify-between px-8 py-6 border-b border-zinc-800 bg-zinc-950/50 shrink-0">
                    <div>
                        <h3 class="text-xl font-mono text-medical-400 tracking-tight flex items-center gap-3">
                            <span class="w-2 h-2 bg-medical-400 rounded-full animate-pulse"></span>
                            RAPORT BADAWCZY KORA CORTEX
                        </h3>
                        <p class="text-xs text-zinc-500 uppercase tracking-widest mt-1">Neurotechnologia Cyfrowa i Modulacja Fal Mózgowych</p>
                    </div>
                    <button id="closeGuide" class="p-2 text-zinc-500 hover:text-white border border-transparent hover:border-zinc-700 rounded transition-all">
                        <span class="text-xs font-mono uppercase mr-2">Zamknij</span> ✕
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 sm:p-12 doc-scroll">
                    <div class="max-w-3xl mx-auto space-y-12 text-zinc-300 leading-relaxed font-light">
                        <section>
                            <h4 class="text-2xl font-light text-white mb-6 border-b border-zinc-800 pb-2">Wstęp: Ewolucja Paradygmatu</h4>
                            <p class="mb-4">Niniejszy raport stanowi kompleksowy wsad merytoryczny do dokumentacji technicznej projektu "Kora Cortex". Dokument ten, opracowany z perspektywy Senior Neuroscientist i Data Researcher, ma na celu dostarczenie rygorystycznej analizy mechanizmów biofizycznych i neurofizjologicznych leżących u podstaw technologii entrainmentu fal mózgowych (Brainwave Entrainment – BWE). W obliczu dynamicznego rozwoju sektora cyfrowych terapeutyków (DTx) oraz rosnącej świadomości w zakresie neuroplastyczności i higieny psychicznej, "Kora Cortex" aspiruje do roli precyzyjnego instrumentu neuromodulacji, wykraczającego poza konwencjonalne aplikacje relaksacyjne. Analiza opiera się na systematycznym przeglądzie literatury, obejmującym badania nad odpowiedzią podążania za częstotliwością (Frequency Following Response – FFR), stochastycznym rezonansem, dynamiką układu glimfatycznego oraz wpływem specyficznych pasm częstotliwości na kognicję i neuroprotekcję.</p>
                            <p class="text-sm bg-zinc-900/50 p-4 border-l-2 border-medical-400 text-zinc-400">Współczesna neuronauka przechodzi transformację, w której niefarmakologiczne metody interwencji, takie jak stymulacja sensoryczna, zyskują status klinicznie weryfikowalnych narzędzi. Celem niniejszego opracowania jest zdefiniowanie naukowych fundamentów dla algorytmów "Kora Cortex", krytyczna ocena skuteczności różnych modalności stymulacji (dudnienia różnicowe vs. tony izochroniczne) oraz wyznaczenie rygorystycznych granic bezpieczeństwa, w tym dla fotostymulacji, zgodnie z międzynarodowymi standardami medycznymi.</p>
                        </section>
                        <section>
                            <h4 class="text-xl font-mono text-medical-400 mb-4 mt-8">1. Neurofizjologiczne Podstawy Entrainmentu</h4>
                            <h5 class="text-lg text-white font-medium mb-2">1.1 Dynamika FFR</h5>
                            <p class="mb-4">
                                Fundamentem działania aplikacji klasyfikowanych jako "Digital Drug" lub narzędzia bio-hakingowe jest zjawisko odpowiedzi podążania za częstotliwością (Frequency Following Response – FFR). Jest to wskaźnik wierności kodowania neuronalnego, który odzwierciedla zdolność układu nerwowego do synchronizacji wewnętrznych oscylacji z periodycznym bodźcem zewnętrznym. Współczesne badania (Coffey et al., 2021) zrewolucjonizowały podejście, dowodząc znaczącego udziału kory słuchowej w generowaniu FFR, co implikuje wpływ na wyższe funkcje poznawcze.
                            </p>
                            <h5 class="text-lg text-white font-medium mb-2 mt-6">1.2 Ścieżki Przetwarzania Sygnału</h5>
                            <p class="mb-4">Skuteczność entrainmentu zależy bezpośrednio od tego, w jaki sposób sygnał akustyczny jest przetwarzany na drodze od ślimaka do kory słuchowej.</p>
                            <ul class="list-disc list-outside ml-5 space-y-2 text-sm text-zinc-400">
                                <li><strong class="text-zinc-200">Binaural Beats:</strong> Konstrukt percepcyjny w oliwie górnej (pień mózgu). Wymaga słuchawek.</li>
                                <li><strong class="text-zinc-200">Isochronic Tones:</strong> Fizyczne modulacje kodowane w ślimaku. Silniejsza synchronizacja wzgórzowo-korowa.</li>
                            </ul>
                        </section>
                        <section>
                            <h4 class="text-xl font-mono text-medical-400 mb-4 mt-8">2. Architektura Audytywna</h4>
                            <div class="overflow-x-auto border border-zinc-800 rounded bg-zinc-900/30">
                                <table class="science-table">
                                    <thead><tr><th>Metoda</th><th>Mechanizm</th><th>Efektywność</th><th>Zastosowanie w Kora</th></tr></thead>
                                    <tbody>
                                        <tr><td>Binaural Beats</td><td>Oliwa górna (pień).</td><td>Umiarkowana.</td><td>Relaks, Delta/Theta.</td></tr>
                                        <tr><td>Isochronic Tones</td><td>Wzgórze.</td><td>Wysoka.</td><td>Gamma/Beta, Energetyzacja.</td></tr>
                                        <tr><td>Pink Noise</td><td>Stochastyczny Rezonans.</td><td>Wsparcie snu.</td><td>Maskowanie tła.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>
                        <section>
                            <h4 class="text-xl font-mono text-medical-400 mb-4 mt-8">3. Spektrum Częstotliwości i Zastosowania</h4>
                            <div class="grid gap-6">
                                <div class="border border-zinc-800 p-5 rounded bg-zinc-900/20">
                                    <h5 class="text-white font-bold text-sm uppercase tracking-wider mb-2">Gamma (30-100 Hz): Neuroprotekcja</h5>
                                    <p class="text-sm text-zinc-400">Metoda GENUS (MIT). Stymulacja 40 Hz wpływa na mikroglej, zwiększając fagocytozę beta-amyloidu. Moduluje układ naczyniowy (wazodylatacja), wspierając "higienę neuronalną".</p>
                                </div>
                                <div class="border border-zinc-800 p-5 rounded bg-zinc-900/20">
                                    <h5 class="text-white font-bold text-sm uppercase tracking-wider mb-2">Delta (0.5-4 Hz): Układ Glimfatyczny</h5>
                                    <p class="text-sm text-zinc-400">Podczas snu NREM przestrzeń śródmiąższowa ekspanduje o 60% (Xie et al., 2013). Wolne oscylacje działają jak pompa hydrauliczna dla płynu CSF, wypłukując neurotoksyny.</p>
                                </div>
                                <div class="border border-zinc-800 p-5 rounded bg-zinc-900/20">
                                    <h5 class="text-white font-bold text-sm uppercase tracking-wider mb-2">Alpha (8-12 Hz): Flow State</h5>
                                    <p class="text-sm text-zinc-400">Związane z <em>transient hypofrontality</em> - przejściowym wyciszeniem kory przedczołowej. Kluczowe dla "odprężonej czujności".</p>
                                </div>
                            </div>
                        </section>
                        <section>
                            <h4 class="text-xl font-mono text-medical-400 mb-4 mt-8">4. Bezpieczeństwo: Protokół Harding FPA</h4>
                            <p class="mb-4 text-sm">Wdrożenie modułów wizualnych wymaga rygorystycznego przestrzegania standardów prewencji epilepsji fotogennej (PSE).</p>
                            <ul class="list-disc list-inside text-sm space-y-2 text-zinc-400 bg-red-900/10 p-4 border border-red-900/30 rounded">
                                <li><strong>Częstotliwość:</strong> Unikać silnego migotania 15-25 Hz (szczyt ryzyka).</li>
                                <li><strong>Luminancja:</strong> Limit zmiany luminancji < 20 cd/m².</li>
                                <li><strong>Red Flash:</strong> Max 3 przejścia do nasyconej czerwieni na sekundę.</li>
                            </ul>
                        </section>
                        <section class="border-t border-zinc-800 pt-8 mt-12"><h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-6">Wybrana Bibliografia</h4><ul class="text-[10px] text-zinc-500 space-y-2 font-mono"><li>[1] Coffey et al. (2021). Oscillatory Entrainment of the Frequency-following Response.</li><li>[9] Guillot et al. (2024). Brain wave modulation and EEG power changes...</li><li>[19] Xie et al. (2013). Sleep Drives Metabolite Clearance from the Adult Brain.</li><li>[20] Tsai et al. (2025). Evidence that 40Hz gamma stimulation promotes brain health. MIT News.</li><li>[44] Harding FPA Guidelines for Photosensitive Epilepsy.</li></ul></section>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAFETY MODAL -->
        <div id="safetyModal" class="fixed inset-0 z-[70] bg-black/95 backdrop-blur-sm hidden items-center justify-center p-4 sm:p-8">
            <div class="bg-zinc-950 border border-zinc-800 rounded-xl w-full max-w-3xl h-full max-h-[85vh] shadow-2xl relative flex flex-col ring-1 ring-white/10">
                <div class="flex items-center justify-between px-8 py-6 border-b border-zinc-800 bg-zinc-950/50 shrink-0">
                    <div>
                        <h3 class="text-xl font-mono text-medical-400 tracking-tight flex items-center gap-3">
                            <span class="w-2 h-2 bg-medical-400 rounded-full animate-pulse"></span>
                            Instrukcja Bezpieczeństwa
                        </h3>
                        <p class="text-xs text-zinc-500 uppercase tracking-widest mt-1">Wytyczne przed uruchomieniem wizualizacji i audio</p>
                    </div>
                    <button id="closeSafety" class="p-2 text-zinc-500 hover:text-white border border-transparent hover:border-zinc-700 rounded transition-all">
                        <span class="text-xs font-mono uppercase mr-2">Zamknij</span> ✕
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 doc-scroll text-sm leading-relaxed space-y-6 text-zinc-300">
                    <div class="bg-red-900/10 border border-red-900/40 rounded p-4 text-red-200 font-semibold uppercase tracking-widest text-[11px]">UWAGA: Silne bodźce wizualne i dźwiękowe. Nie używać w przypadku epilepsji fotogennej ani podczas prowadzenia pojazdów.</div>
                    <section class="space-y-2">
                        <h4 class="text-lg text-white font-semibold">Przeciwwskazania</h4>
                        <ul class="list-disc list-inside space-y-1 text-zinc-400">
                            <li>Nadwrażliwość na światło (PSE), stany po urazach neurologicznych, migreny z aurą.</li>
                            <li>Stosowanie leków obniżających próg drgawkowy – skonsultuj użycie z lekarzem.</li>
                            <li>Zmęczenie, odwodnienie lub brak snu mogą zwiększać dyskomfort sensoryczny.</li>
                        </ul>
                    </section>
                    <section class="space-y-2">
                        <h4 class="text-lg text-white font-semibold">Zasady korzystania</h4>
                        <ul class="list-disc list-inside space-y-1 text-zinc-400">
                            <li>Zawsze używaj słuchawek stereo i zaczynaj od niskiej głośności.</li>
                            <li>Włącz „Safe visuals” lub „Audio-only” przy pierwszym użyciu lub przy wrażliwości na bodźce.</li>
                            <li>Przerwij sesję przy zawrotach głowy, mdłościach, mroczkach lub dyskomforcie.</li>
                            <li>Unikaj patrzenia w jasne źródła światła w zaciemnionych pomieszczeniach podczas intensywnych protokołów.</li>
                        </ul>
                    </section>
                    <section class="space-y-2">
                        <h4 class="text-lg text-white font-semibold">Wskazówki praktyczne</h4>
                        <ul class="list-disc list-inside space-y-1 text-zinc-400">
                            <li>Przed snem wybieraj łagodne tryby (Hypnos/Restoration) i unikaj światła niebieskiego.</li>
                            <li>Rób przerwy między sesjami (min. 10 minut) i nawadniaj się.</li>
                            <li>Testuj kanały L/R w ustawieniach przed dłuższymi sesjami.</li>
                        </ul>
                    </section>
                </div>
            </div>
        </div>

        <!-- PROGRAMS MODAL -->
        <div id="programModal" class="fixed inset-0 z-[70] bg-black/95 backdrop-blur-sm hidden items-center justify-center p-4 sm:p-8">
            <div class="bg-zinc-950 border border-zinc-800 rounded-xl w-full max-w-5xl h-full max-h-[85vh] shadow-2xl relative flex flex-col ring-1 ring-white/10">
                <div class="flex items-center justify-between px-8 py-6 border-b border-zinc-800 bg-zinc-950/50 shrink-0">
                    <div>
                        <h3 class="text-xl font-mono text-medical-400 tracking-tight flex items-center gap-3">
                            <span class="w-2 h-2 bg-medical-400 rounded-full animate-pulse"></span>
                            Programy Kora
                        </h3>
                        <p class="text-xs text-zinc-500 uppercase tracking-widest mt-1">Sekwencje kilku protokołów z pauzą między krokami.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-zinc-925 border border-zinc-800/60 text-[10px] font-mono text-zinc-400 uppercase tracking-widest">
                            <span class="w-2 h-2 rounded-full bg-medical-900/70"></span>
                            <span id="programStatusModal">Brak aktywnego programu</span>
                        </div>
                        <button id="closeProgram" class="p-2 text-zinc-500 hover:text-white border border-transparent hover:border-zinc-700 rounded transition-all">
                            <span class="text-xs font-mono uppercase mr-2">Zamknij</span> ✕
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-8 doc-scroll">
                    <div id="programList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <script>
            const sessions = {
                hypnos: {
                    id: "hypnos", name: "Hypnos", category: "Sleep",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
                    desc: "Głęboka architektura snu. Delta (0.5-2Hz) ułatwia zasypianie i podtrzymuje fazę N3. Tryb nieskończony.",
                    duration: Infinity,
                    baseHz: "Delta 0.5-2Hz",
                    phases: [
                        { name: "Indukcja Snu", start: 0, end: 900, audio: { l: 100, r: 108, vol_s: 0.2, vol_e: 0.15 }, visual: { f: 6, mod: 'soft', bri: 0.3 } },
                        { name: "Głęboki Sen", start: 900, end: Infinity, audio: { l: 60, r: 61, vol: 0.15 }, visual: { f: 0.5, mod: 'breath', bri: 0.05 } }
                    ]
                },
                prime: {
                    id: "prime", name: "Prime", category: "Activation",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
                    desc: "Rozgrzewka neuronalna (5 min). Łagodne przejście z fal Alpha do Beta. Idealne na start dnia.",
                    duration: 300,
                    baseHz: "Alpha -> Beta",
                    phases: [
                        { name: "Inicjacja Alpha", start: 0, end: 120, audio: { l: 220, r: 228, vol_s: 0.1, vol_e: 0.3 }, visual: { f: 8, mod: 'soft', bri: 0.6 } },
                        { name: "Aktywacja Beta", start: 120, end: 300, audio: { l: 220, r: 234, vol: 0.35 }, visual: { f: 14, mod: 'soft', bri: 0.8 } }
                    ]
                },
                overdrive: {
                    id: "overdrive",
                    name: "Overdrive",
                    category: "Activation",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>`,
                    desc: "Intensywna stymulacja Gamma (30-40Hz). Krótka sesja do przełamania prokrastynacji.", duration: 300, baseHz: "Gamma 40Hz",
                    phases: [{ name: "Ramp Up", start: 0, end: 60, audio: { l: 440, r: 470, vol_s: 0.3, vol_e: 0.5 }, visual: { f_s: 20, f_e: 35, mod: 'hard' } }, { name: "Gamma Peak", start: 60, end: 240, audio: { l: 440, r: 480, mod: 'pulse' }, visual: { f: 40, mod: 'hard', bri: 1.0 } }, { name: "Cool Down", start: 240, end: 300, audio: { l: 440, r: 460, vol_s: 0.5, vol_e: 0.2 }, visual: { f_s: 30, f_e: 10, mod: 'soft' } }]
                },
                deepFocus: {
                    id: "deepFocus",
                    name: "Deep Focus",
                    category: "Work",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
                    desc: "Klasyczne głębokie skupienie (15 min). Stabilne fale Beta pomagają utrzymać koncentrację na jednym zadaniu.",
                    duration: 900,
                    baseHz: "Beta 14-18Hz",
                    phases: [
                        { name: "Indukcja", start: 0, end: 120, audio: { l: 210, r: 224, vol_s: 0.1, vol_e: 0.3 }, visual: { f: 10, mod: 'soft', bri: 0.7 } },
                        { name: "Tunel", start: 120, end: 780, audio: { l: 230, r: 248, vol: 0.4 }, visual: { f: 14, mod: 'soft', bri: 0.85 } },
                        { name: "Wyjście", start: 780, end: 900, audio: { l: 210, r: 224, vol_s: 0.3, vol_e: 0.1 }, visual: { f: 10, mod: 'soft', bri: 0.6 } }
                    ]
                },
                clarity: {
                    id: "clarity",
                    name: "Clarity",
                    category: "Work",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`,
                    desc: "Myślenie strategiczne. Zbalansowana sesja Alpha/Beta sprzyjająca planowaniu i porządkowaniu myśli.",
                    duration: 720,
                    baseHz: "Isochronic 12Hz",
                    phases: [
                        { name: "Centrowanie", start: 0, end: 180, audio: { l: 220, r: 232, vol_s: 0.2, vol_e: 0.35 }, visual: { f: 10, mod: 'soft' } },
                        { name: "Analiza", start: 180, end: 600, audio: { l: 220, r: 236, mod: 'iso' }, visual: { f: 12, mod: 'soft' } },
                        { name: "Synteza", start: 600, end: 720, audio: { l: 220, r: 232, vol_s: 0.35, vol_e: 0.1 }, visual: { f: 8, mod: 'soft' } }
                    ]
                },
                genesis: {
                    id: "genesis",
                    name: "Genesis",
                    category: "Creative",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>`,
                    desc: "Stan Flow (Theta 6-7Hz). Głęboki relaks połączony z wizualizacją. Idealny do burzy mózgów i zadań kreatywnych.",
                    duration: 600,
                    baseHz: "Theta 6Hz",
                    phases: [
                        { name: "Zejście", start: 0, end: 120, audio: { l: 180, r: 190, vol_s: 0.2, vol_e: 0.3 }, visual: { f: 10, mod: 'soft', bri: 0.6 } },
                        { name: "Theta Flow", start: 120, end: 500, audio: { l: 150, r: 156, vol: 0.35 }, visual: { f: 6, mod: 'soft', bri: 0.5 } },
                        { name: "Powrót", start: 500, end: 600, audio: { l: 180, r: 190, vol_s: 0.3, vol_e: 0.1 }, visual: { f: 8, mod: 'soft', bri: 0.4 } }
                    ]
                },
                equilibrium: {
                    id: "equilibrium",
                    name: "Equilibrium",
                    category: "Calm",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h5l3 5 5-11 4 6h3"></path></svg>`,
                    desc: "Redukcja lęku i stresu. Stabilne 10Hz (Alpha) uziemia i uspokaja układ nerwowy bez usypiania.",
                    duration: 420,
                    baseHz: "Solid Alpha 10Hz",
                    phases: [
                        { name: "Uziemienie", start: 0, end: 60, audio: { l: 200, r: 212, vol_s: 0.15, vol_e: 0.25 }, visual: { f: 12, mod: 'soft', bri: 0.6 } },
                        { name: "Stabilizacja", start: 60, end: 360, audio: { l: 200, r: 210, vol: 0.3 }, visual: { f: 10, mod: 'breath', bri: 0.7 } },
                        { name: "Wyciszenie", start: 360, end: 420, audio: { l: 200, r: 208, vol_s: 0.25, vol_e: 0.1 }, visual: { f: 8, mod: 'breath', bri: 0.5 } }
                    ]
                },
                restoration: {
                    id: "restoration",
                    name: "Restoration",
                    category: "Calm",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.354 15.354A9 9 0 0 1 8.646 3.646 9.003 9.003 0 0 0 12 21a9.003 9.003 0 0 0 8.354-5.646z"></path></svg>`,
                    desc: "Głęboka regeneracja (Delta 2-4Hz). Bardzo powolne fale dla fizycznego i mentalnego odpoczynku.",
                    duration: 900,
                    baseHz: "Delta 3Hz",
                    phases: [
                        { name: "Zwolnienie", start: 0, end: 180, audio: { l: 100, r: 108, vol_s: 0.15, vol_e: 0.25 }, visual: { f: 8, mod: 'soft', bri: 0.5 } },
                        { name: "Delta Immersion", start: 180, end: 800, audio: { l: 100, r: 103, vol: 0.3 }, visual: { f: 3, mod: 'breath', bri: 0.3 } },
                        { name: "Przebudzenie", start: 800, end: 900, audio: { l: 100, r: 108, vol_s: 0.25, vol_e: 0.1 }, visual: { f: 6, mod: 'soft', bri: 0.4 } }
                    ]
                },
                presence: {
                    id: "presence",
                    name: "Presence",
                    category: "Work",
                    icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
                    desc: "Gotowość społeczna. Lekkie pobudzenie przed spotkaniem.",
                    duration: 420,
                    baseHz: "Alpha 10Hz",
                    phases: [
                        { name: "Flow", start: 0, end: 360, audio: { l: 240, r: 250, vol_s: 0.2, vol_e: 0.35 }, visual: { f: 10, mod: 'soft' } },
                        { name: "Spokój", start: 360, end: 420, audio: { l: 240, r: 250, vol_s: 0.35, vol_e: 0.1 }, visual: { f: 8, mod: 'soft' } }
                    ]
                }
            };

            const programs = [
                {
                    id: 'flow90',
                    name: 'Flow 90',
                    description: 'Pełna ścieżka od pobudzenia do wyciszenia w 90 minut.',
                    steps: [
                        { sessionId: 'prime', durationMinutes: 5 },
                        { sessionId: 'deepFocus', durationMinutes: 60 },
                        { sessionId: 'genesis', durationMinutes: 10 },
                        { sessionId: 'equilibrium', durationMinutes: 15 }
                    ]
                },
                {
                    id: 'socialUpgrade',
                    name: 'Social Upgrade',
                    description: 'Przygotowanie do spotkań – delikatne pobudzenie i uspokojenie.',
                    steps: [
                        { sessionId: 'presence', durationMinutes: 7 },
                        { sessionId: 'equilibrium', durationMinutes: 10 }
                    ]
                },
                {
                    id: 'sleepReset',
                    name: 'Sleep Reset',
                    description: 'Wieczorna sekwencja do regeneracji i snu.',
                    steps: [
                        { sessionId: 'restoration', durationMinutes: 20 },
                        { sessionId: 'hypnos', durationMinutes: 90 }
                    ]
                },
                {
                    id: 'powerNap45',
                    name: 'Power Nap 45',
                    description: 'Krótka sekwencja regeneracyjna na przerwę w ciągu dnia.',
                    steps: [
                        { sessionId: 'equilibrium', durationMinutes: 10 },
                        { sessionId: 'hypnos', durationMinutes: 30 },
                        { sessionId: 'genesis', durationMinutes: 5 }
                    ]
                },
                {
                    id: 'creativeBloom',
                    name: 'Creative Bloom',
                    description: 'Delikatne pobudzenie i flow dla pracy koncepcyjnej.',
                    steps: [
                        { sessionId: 'presence', durationMinutes: 8 },
                        { sessionId: 'deepFocus', durationMinutes: 45 },
                        { sessionId: 'equilibrium', durationMinutes: 10 }
                    ]
                }
            ];

            // User Preferences (localStorage) helper
            const defaultPreferences = {
                lastSessionId: 'prime',
                preferredNoiseType: 'brown',
                breathEnabled: false,
                breathPattern: 'auto',
                hypnosDuration: 'infinity',
                onboardingCompleted: false,
                safeVisuals: false,
                audioOnly: false,
                intensityLevel: 'medium'
            };

            const userPreferences = {
                key: 'koraUserPreferences',
                data: { ...defaultPreferences },
                load() {
                    try {
                        const raw = localStorage.getItem(this.key);
                        if (raw) this.data = { ...defaultPreferences, ...JSON.parse(raw) };
                        else this.data = { ...defaultPreferences };
                    } catch (e) {
                        console.warn('Preferences load failed, using defaults', e);
                        this.data = { ...defaultPreferences };
                    }
                    return this.data;
                },
                save(patch = {}) {
                    this.data = { ...this.data, ...patch };
                    try { localStorage.setItem(this.key, JSON.stringify(this.data)); } catch (e) { console.warn('Preferences save failed', e); }
                }
            };

            userPreferences.load();

            // Hypnos duration presets (values in minutes, converted to seconds later)
            const HYPNOS_TEST_ACCELERATION = 1; // Set to 60 to make "1s = 1min" for quick manual tests
            const hypnosDurations = {
                '30': 30,
                '45': 45,
                '90': 90,
                'infinity': Infinity
            };

            // Safety/display preferences: safe visuals limit flicker/contrast, audio-only disables animations, intensity scales gain
            const intensityProfiles = {
                low: { gain: 0.6, delta: 0.9 },
                medium: { gain: 1, delta: 1 },
                high: { gain: 1.3, delta: 1.1 }
            };

            const breathPatterns = {
                auto: { label: 'Auto (wg trybu)' },
                '4-6': { label: '4–6', sequence: [
                    { label: 'IN', duration: 4 },
                    { label: 'OUT', duration: 6 }
                ] },
                '4-7-8': { label: '4–7–8', sequence: [
                    { label: 'IN', duration: 4 },
                    { label: 'HOLD', duration: 7 },
                    { label: 'OUT', duration: 8 }
                ] },
                box: { label: 'Box 4–4–4–4', sequence: [
                    { label: 'IN', duration: 4 },
                    { label: 'HOLD', duration: 4 },
                    { label: 'OUT', duration: 4 },
                    { label: 'HOLD', duration: 4 }
                ] }
            };

            const autoBreathMap = {
                equilibrium: 'box',
                presence: 'box',
                hypnos: '4-7-8',
                restoration: '4-7-8',
                prime: '4-6',
                overdrive: '4-6',
                deepFocus: '4-6'
            };

            const hypnosBasePhases = JSON.parse(JSON.stringify(sessions.hypnos.phases));

            let state = {
                active: false,
                session: userPreferences.data.lastSessionId || 'prime',
                startTime: 0,
                preview: false,
                focusLock: false,
                noiseType: userPreferences.data.preferredNoiseType || 'brown',
                breathingPacer: !!userPreferences.data.breathEnabled,
                breathPattern: userPreferences.data.breathPattern || 'auto',
                hypnosDuration: userPreferences.data.hypnosDuration || 'infinity',
                safeVisuals: !!userPreferences.data.safeVisuals,
                audioOnly: !!userPreferences.data.audioOnly,
                intensityLevel: userPreferences.data.intensityLevel || 'medium',
                sessionDataOverride: null,
                program: { active: false, id: null, stepIndex: 0, awaitingNext: false },
                hypnosRampProgress: 0,
                hypnosRampTimer: null,
                ctx: null,
                audio: {
                    oscL: null,
                    oscR: null,
                    gain: null,
                    noise: null,
                    noiseGain: null
                },
                analyser: null,
                lastInteraction: 0 // For UI dimming
            };

            const els = {
                canvas: document.getElementById('visualCanvas'),
                timer: document.getElementById('timer'),
                progressBar: document.getElementById('progressBar'),
                mainBtn: document.getElementById('mainActionBtn'),
                modeContainer: document.getElementById('modeContainer'),
                msgBox: document.getElementById('message-box'),
                desc: document.getElementById('modeDesc'),
                messageTitle: document.getElementById('messageTitle'),
                realtimeHz: document.getElementById('realtimeHz'),
                phaseName: document.getElementById('currentPhaseName'),
                statusDot: document.getElementById('statusDot'),
                statusText: document.getElementById('statusText'),
                settingsModal: document.getElementById('settingsModal'),
                guideModal: document.getElementById('guideModal'),
                programModal: document.getElementById('programModal'),
                safetyModal: document.getElementById('safetyModal'),
                programToggle: document.getElementById('programToggle'),
                closeProgram: document.getElementById('closeProgram'),
                controlPanel: document.getElementById('controlPanel'),
                noiseTypeDisplay: document.getElementById('noiseTypeDisplay'),
                btnPink: document.getElementById('setPinkNoise'),
                btnBrown: document.getElementById('setBrownNoise'),
                breathToggle: document.getElementById('breathToggle'),
                breathPatternButtons: Array.from(document.querySelectorAll('#breathPatternButtons .breath-pattern-btn')),
                breathPatternSummary: document.getElementById('breathPatternSummary'),
                breathPatternHelper: document.getElementById('breathPatternHelper'),
                safeVisualsToggle: document.getElementById('safeVisualsToggle'),
                audioOnlyToggle: document.getElementById('audioOnlyToggle'),
                intensityButtons: Array.from(document.querySelectorAll('#intensityButtons .intensity-btn')),
                hypnosDurationCard: document.getElementById('hypnosDurationCard'),
                hypnosDurationButtons: Array.from(document.querySelectorAll('#hypnosDurationButtons button')),
                programList: document.getElementById('programList'),
                programStatus: document.getElementById('programStatus'),
                programStatusModal: document.getElementById('programStatusModal'),
                programOverlay: document.getElementById('programOverlay'),
                programOverlayTitle: document.getElementById('programOverlayTitle'),
                programOverlayBody: document.getElementById('programOverlayBody'),
                programOverlayLabel: document.getElementById('programOverlayLabel'),
                programOverlayStep: document.getElementById('programOverlayStep'),
                programOverlayStepMeta: document.getElementById('programOverlayStepMeta'),
                programContinueBtn: document.getElementById('programContinueBtn'),
                programEndBtn: document.getElementById('programEndBtn'),
                // Elements for Landing Page
                landingPage: document.getElementById('landingPage'),
                enterSystemBtn: document.getElementById('enterSystemBtn'),
                appInterface: document.getElementById('appInterface'),
                landingGlow: document.getElementById('landingGlow'),
                silentAudio: document.getElementById('silentAudioLoop'),
                circadianWidget: document.getElementById('circadianWidget'),
                circadianTitle: document.getElementById('circadianTitle'),
                leftPanel: document.getElementById('leftPanel'),
                appFooter: document.getElementById('appFooter'),
                appHeader: document.getElementById('appHeader')
            };

            function init() {
                // Initialization Logic
                applyHypnosDuration(state.hypnosDuration);
                renderModes();
                renderPrograms();
                setSession(state.session);
                initCanvas();
                updateNoiseUI();
                els.breathToggle.checked = state.breathingPacer;
                els.safeVisualsToggle.checked = state.safeVisuals;
                els.audioOnlyToggle.checked = state.audioOnly;
                updateIntensityUI();
                updateBreathPatternUI();
                updateHypnosDurationUI();
                updateProgramStatus();
                checkCircadianRhythm();

                window.addEventListener('resize', resizeCanvas);
                setInterval(checkCircadianRhythm, 60000);

                // Activity tracking for Hypnos dimming
                ['mousemove', 'mousedown', 'keydown', 'touchstart'].forEach(evt => {
                    document.addEventListener(evt, () => {
                        state.lastInteraction = performance.now();
                        // Wake up UI
                        els.appHeader.style.opacity = '1';
                        els.leftPanel.style.opacity = '1';
                        els.controlPanel.style.opacity = '1';
                        els.appFooter.style.opacity = '1';
                    });
                });

                // Interactive Glow on Landing
                document.addEventListener('mousemove', (e) => {
                    if(els.landingPage.style.display !== 'none') {
                        const x = e.clientX;
                        const y = e.clientY;
                        els.landingGlow.style.left = x + 'px';
                        els.landingGlow.style.top = y + 'px';
                    }
                });

                // Landing Page Logic
                els.enterSystemBtn.addEventListener('click', () => {
                    const content = els.landingPage.querySelector('.max-w-5xl');
                    content.style.opacity = '0';
                    content.style.transition = 'opacity 0.5s';

                    els.silentAudio.play().catch(e => console.log("Silent play prevented"));

                    setTimeout(() => {
                        els.landingPage.style.display = 'none';
                        const calib = document.getElementById('calibrationOverlay');
                        calib.style.display = 'flex';
                        simulateCalibration(() => {
                            els.appInterface.style.display = 'block';
                            requestAnimationFrame(() => {
                                els.appInterface.style.opacity = '1';
                                resizeCanvas();
                            });
                        });
                    }, 500);
                });

                els.mainBtn.addEventListener('click', toggleSession);
                document.getElementById('previewButton').addEventListener('click', togglePreview);
                document.getElementById('fullscreenButton').addEventListener('click', toggleFullscreen);
                document.getElementById('focusLockToggle').addEventListener('change', (e) => state.focusLock = e.target.checked);

                // Settings
                document.getElementById('settingsToggle').addEventListener('click', () => els.settingsModal.style.display = 'flex');
                document.getElementById('closeSettings').addEventListener('click', () => els.settingsModal.style.display = 'none');

                // Guide
                document.getElementById('guideToggle').addEventListener('click', () => els.guideModal.style.display = 'flex');
                document.getElementById('closeGuide').addEventListener('click', () => els.guideModal.style.display = 'none');

                // Programs
                const openProgramModal = () => {
                    if(!els.programModal || !els.programList) return;
                    renderPrograms();
                    updateProgramStatus();
                    els.programModal.classList.remove('hidden');
                    els.programModal.style.display = 'flex';
                };
                const closeProgramModal = () => {
                    if(!els.programModal) return;
                    els.programModal.classList.add('hidden');
                    els.programModal.style.display = 'none';
                };
                els.programToggle.addEventListener('click', openProgramModal);
                els.closeProgram.addEventListener('click', closeProgramModal);

                // Safety
                document.getElementById('safetyToggle').addEventListener('click', () => els.safetyModal.style.display = 'flex');
                document.getElementById('closeSafety').addEventListener('click', () => els.safetyModal.style.display = 'none');

                // Audio Tests
                document.getElementById('testLeftButton').addEventListener('click', () => playTestTone(-1));
                document.getElementById('testRightButton').addEventListener('click', () => playTestTone(1));

                // Noise Selection
                els.btnPink.addEventListener('click', () => setNoiseType('pink'));
                els.btnBrown.addEventListener('click', () => setNoiseType('brown'));

                // Breathing Pacer
                els.breathToggle.addEventListener('change', (e) => {
                    state.breathingPacer = e.target.checked;
                    userPreferences.save({ breathEnabled: state.breathingPacer });
                });

                // Safety & display modes
                els.safeVisualsToggle.addEventListener('change', (e) => setSafeVisuals(e.target.checked));
                els.audioOnlyToggle.addEventListener('change', (e) => setAudioOnly(e.target.checked));

                // Intensity selection
                els.intensityButtons.forEach(btn => {
                    btn.addEventListener('click', () => setIntensity(btn.dataset.intensity));
                });

                // Breath pattern selection
                els.breathPatternButtons.forEach(btn => {
                    btn.addEventListener('click', () => setBreathPattern(btn.dataset.pattern));
                });

                // Hypnos durations
                els.hypnosDurationButtons.forEach(btn => {
                    btn.addEventListener('click', () => setHypnosDuration(btn.dataset.duration));
                });

                els.programContinueBtn.addEventListener('click', () => startProgramStep(state.program.stepIndex));
                els.programEndBtn.addEventListener('click', endProgram);

                // Circadian Widget Click
                els.circadianWidget.addEventListener('click', () => {
                    const recommended = els.circadianWidget.dataset.recommended;
                    if(recommended) setSession(recommended);
                });

                requestAnimationFrame(loop);
            }

            // Circadian Sync Logic
            function checkCircadianRhythm() {
                const hour = new Date().getHours();
                let recId = 'prime';
                let recText = 'Inicjalizacja';

                if (hour >= 5 && hour < 10) { recId = 'prime'; recText = 'Okno: Kortyzol / Start'; }
                else if (hour >= 10 && hour < 14) { recId = 'deepFocus'; recText = 'Okno: Produktywność'; }
                else if (hour >= 14 && hour < 17) { recId = 'genesis'; recText = 'Okno: Reset / Theta'; }
                else if (hour >= 17 && hour < 21) { recId = 'clarity'; recText = 'Okno: Integracja'; }
                else { recId = 'hypnos'; recText = 'Okno: Melatonina'; }

                els.circadianTitle.textContent = recText;
                els.circadianWidget.dataset.recommended = recId;
            }

            function setNoiseType(type) {
                state.noiseType = type;
                userPreferences.save({ preferredNoiseType: type });
                updateNoiseUI();
                if(state.active && state.audio.noise) {
                    state.audio.noise.type = type;
                }
            }

            function updateNoiseUI() {
                const active = ['bg-medical-900', 'border-medical-400', 'text-white', 'shadow-[0_0_12px_rgba(34,211,238,0.35)]'];
                const inactive = ['bg-zinc-800', 'border-zinc-700', 'text-zinc-300', 'shadow-none'];
                const setState = (btn, isActive) => {
                    active.forEach(c => btn.classList.toggle(c, isActive));
                    inactive.forEach(c => btn.classList.toggle(c, !isActive));
                };

                const isPink = state.noiseType === 'pink';
                setState(els.btnPink, isPink);
                setState(els.btnBrown, !isPink);
                els.noiseTypeDisplay.textContent = isPink ? "Pink Noise (Soft)" : "Brown Noise (Deep)";
            }

            // UI + storage: safe visuals and audio-only toggles with intensity selection
            function setSafeVisuals(enabled) {
                state.safeVisuals = !!enabled;
                els.safeVisualsToggle.checked = state.safeVisuals;
                userPreferences.save({ safeVisuals: state.safeVisuals });
            }

            function setAudioOnly(enabled) {
                state.audioOnly = !!enabled;
                els.audioOnlyToggle.checked = state.audioOnly;
                userPreferences.save({ audioOnly: state.audioOnly });
            }

            function setIntensity(level) {
                if(!intensityProfiles[level]) level = 'medium';
                state.intensityLevel = level;
                userPreferences.save({ intensityLevel: level });
                updateIntensityUI();
            }

            function updateIntensityUI() {
                els.intensityButtons.forEach(btn => {
                    const active = btn.dataset.intensity === state.intensityLevel;
                    btn.classList.toggle('bg-medical-900/40', active);
                    btn.classList.toggle('border-medical-400/60', active);
                    btn.classList.toggle('text-white', active);
                    btn.classList.toggle('shadow-[0_0_12px_rgba(34,211,238,0.3)]', active);
                });
            }

            function resolveBreathPattern() {
                if(state.breathPattern && state.breathPattern !== 'auto') return state.breathPattern;
                return autoBreathMap[state.session] || '4-6';
            }

            function describeBreathSequence(patternId) {
                const pattern = breathPatterns[patternId];
                if(!pattern || !pattern.sequence) return 'Stabilny rytm oddechu';
                return pattern.sequence.map(step => `${step.label} ${step.duration}s`).join(' · ');
            }

            function updateBreathPatternUI() {
                const resolved = resolveBreathPattern();
                const currentLabel = breathPatterns[state.breathPattern]?.label || 'Auto';
                els.breathPatternButtons.forEach(btn => {
                    const active = btn.dataset.pattern === state.breathPattern;
                    btn.classList.toggle('bg-medical-900/40', active);
                    btn.classList.toggle('border-medical-400/60', active);
                    btn.classList.toggle('text-white', active);
                    btn.classList.toggle('shadow-[0_0_12px_rgba(34,211,238,0.3)]', active);
                    btn.classList.toggle('bg-zinc-800', !active);
                    btn.classList.toggle('border-zinc-700', !active);
                    btn.classList.toggle('text-zinc-300', !active);
                });

                const resolvedLabel = breathPatterns[resolved]?.label || '4–6';
                const sequenceText = describeBreathSequence(resolved);
                if(state.breathPattern === 'auto') {
                    const modeName = sessions[state.session]?.name || 'wybranego trybu';
                    els.breathPatternSummary.textContent = `${resolvedLabel} · auto dla ${modeName}`;
                    els.breathPatternHelper.textContent = `Auto wybiera: ${sequenceText}`;
                } else {
                    els.breathPatternSummary.textContent = `${currentLabel} · ${sequenceText}`;
                    els.breathPatternHelper.textContent = sequenceText;
                }
            }

            function setBreathPattern(pattern) {
                state.breathPattern = breathPatterns[pattern] ? pattern : 'auto';
                userPreferences.save({ breathPattern: state.breathPattern });
                updateBreathPatternUI();
            }

            function getHypnosDurationSeconds(key) {
                const minutes = hypnosDurations[key] ?? hypnosDurations['infinity'];
                if (minutes === Infinity) return Infinity;
                return (minutes * 60) / HYPNOS_TEST_ACCELERATION;
            }

            function applyHypnosDuration(key) {
                const durationSeconds = getHypnosDurationSeconds(key);
                sessions.hypnos.duration = durationSeconds;
                const cloned = JSON.parse(JSON.stringify(hypnosBasePhases));
                cloned[1].end = durationSeconds === Infinity ? Infinity : durationSeconds;
                sessions.hypnos.phases = cloned;
            }

            function getSessionData() {
                return state.sessionDataOverride || sessions[state.session];
            }

            function cloneSessionWithDuration(sessionId, durationSeconds) {
                const base = sessions[sessionId];
                if(!base) return null;
                if(durationSeconds === undefined || durationSeconds === null || durationSeconds === base.duration) return base;
                const referenceDuration = base.duration === Infinity
                    ? base.phases.reduce((max, p) => Math.max(max, p.end === Infinity ? p.start : p.end), 0)
                    : base.duration;
                const ratio = durationSeconds === Infinity || referenceDuration === 0 ? 1 : (durationSeconds / referenceDuration);
                const phases = base.phases.map(p => ({
                    ...p,
                    start: p.start * ratio,
                    end: p.end === Infinity ? Infinity : p.end * ratio,
                    audio: { ...p.audio },
                    visual: { ...p.visual }
                }));
                return { ...base, duration: durationSeconds, phases };
            }

            function getProgramById(id) {
                return programs.find(p => p.id === id);
            }

            function formatProgramStep(step, idx, total) {
                const sessionName = sessions[step.sessionId]?.name || step.sessionId;
                const minutes = step.durationMinutes === Infinity ? '∞' : `${step.durationMinutes} min`;
                return `${idx + 1}/${total}: ${sessionName} · ${minutes}`;
            }

            function renderPrograms() {
                els.programList.innerHTML = '';
                programs.forEach(program => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'border border-white/5 rounded-xl p-4 bg-zinc-950/40 h-full flex flex-col gap-3';
                    const stepsText = program.steps.map((step, idx) => formatProgramStep(step, idx, program.steps.length)).map(text => `<li>${text}</li>`).join('');
                    wrapper.innerHTML = `
                        <div class="flex items-start justify-between gap-3">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold uppercase tracking-widest text-medical-400">${program.name}</span>
                                    <span class="text-[10px] text-zinc-500">${program.steps.length} kroki</span>
                                </div>
                                <p class="text-xs text-zinc-300 leading-relaxed">${program.description}</p>
                            </div>
                            <button data-program="${program.id}" class="program-start px-3 py-2 text-[10px] uppercase tracking-wider bg-medical-400 text-black rounded hover:shadow-[0_0_14px_rgba(34,211,238,0.4)] transition-all">Start programu</button>
                        </div>
                        <ul class="mt-1 text-[11px] text-zinc-300 leading-relaxed space-y-1 list-disc list-inside">${stepsText}</ul>
                    `;
                    els.programList.appendChild(wrapper);
                });

                els.programList.querySelectorAll('.program-start').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.program;
                        startProgram(id);
                    });
                });
            }

            function updateProgramStatus() {
                if(!state.program.active) {
                    els.programStatus.textContent = 'Brak aktywnego programu';
                    if(els.programStatusModal) els.programStatusModal.textContent = 'Brak aktywnego programu';
                    return;
                }
                const program = getProgramById(state.program.id);
                if(!program) {
                    els.programStatus.textContent = 'Program nieznany';
                    if(els.programStatusModal) els.programStatusModal.textContent = 'Program nieznany';
                    return;
                }
                const stepNo = Math.min(state.program.stepIndex + 1, program.steps.length);
                const suffix = state.program.awaitingNext ? ' · pauza' : '';
                const label = `${program.name}: krok ${stepNo}/${program.steps.length}${suffix}`;
                els.programStatus.textContent = label;
                if(els.programStatusModal) els.programStatusModal.textContent = label;
            }

            function hideProgramOverlay() {
                els.programOverlay.classList.add('hidden');
            }

            function showProgramOverlay(config) {
                const { label, title, body, stepText, stepMeta, showContinue } = config;
                els.programOverlayLabel.textContent = label;
                els.programOverlayTitle.textContent = title;
                els.programOverlayBody.textContent = body;
                els.programOverlayStep.textContent = stepText;
                els.programOverlayStepMeta.textContent = stepMeta;
                els.programContinueBtn.classList.toggle('hidden', !showContinue);
                els.programOverlay.classList.remove('hidden');
            }

            function resolveProgramDuration(step) {
                if(step.durationMinutes === Infinity) return Infinity;
                if(typeof step.durationMinutes === 'number') return step.durationMinutes * 60;
                return null;
            }

            function startProgram(programId) {
                const program = getProgramById(programId);
                if(!program || state.active) return;
                if(els.programModal) closeProgramModal();
                state.program = { active: true, id: programId, stepIndex: 0, awaitingNext: false };
                updateProgramStatus();
                startProgramStep(0);
            }

            function startProgramStep(index) {
                const program = getProgramById(state.program.id);
                if(!program) { endProgram(); return; }
                const step = program.steps[index];
                if(!step) { endProgram(); return; }
                state.program.stepIndex = index;
                state.program.awaitingNext = false;
                const durationSeconds = resolveProgramDuration(step);
                setSession(step.sessionId, { overrideDurationSeconds: durationSeconds, skipSave: true });
                updateProgramStatus();
                hideProgramOverlay();
                if(!state.active) toggleSession('program-start');
            }

            function handleProgramAfterStep() {
                if(!state.program.active) return;
                const program = getProgramById(state.program.id);
                if(!program) { endProgram(); return; }
                const nextIndex = state.program.stepIndex + 1;
                if(nextIndex >= program.steps.length) {
                    state.program.active = false;
                    state.program.awaitingNext = false;
                    updateProgramStatus();
                    showProgramOverlay({
                        label: 'Program zakończony',
                        title: `${program.name} ukończony`,
                        body: 'Wszystkie etapy zostały wykonane. Możesz zakończyć program i wrócić do pojedynczych trybów.',
                        stepText: `Zrealizowano ${program.steps.length} / ${program.steps.length} kroków`,
                        stepMeta: '',
                        showContinue: false
                    });
                } else {
                    const nextStep = program.steps[nextIndex];
                    const stepText = formatProgramStep(nextStep, nextIndex, program.steps.length);
                    const minutes = nextStep.durationMinutes === Infinity ? '∞' : `${nextStep.durationMinutes} min`;
                    const sessionName = sessions[nextStep.sessionId]?.name || nextStep.sessionId;
                    state.program.awaitingNext = true;
                    state.program.stepIndex = nextIndex;
                    updateProgramStatus();
                    showProgramOverlay({
                        label: 'Następny etap programu',
                        title: program.name,
                        body: 'Rozpocznij kolejny etap lub zakończ program.',
                        stepText,
                        stepMeta: `${sessionName} · ${minutes}`,
                        showContinue: true
                    });
                }
            }

            function endProgram() {
                state.program = { active: false, id: null, stepIndex: 0, awaitingNext: false };
                state.sessionDataOverride = null;
                hideProgramOverlay();
                updateProgramStatus();
                if(!state.active) setSession(state.session);
            }

            function setHypnosDuration(key) {
                state.hypnosDuration = key;
                userPreferences.save({ hypnosDuration: key });
                applyHypnosDuration(key);
                updateHypnosDurationUI();
                if(state.session === 'hypnos' && !state.active) {
                    els.timer.textContent = formatTime(sessions.hypnos.duration);
                }
            }

            function updateHypnosDurationUI() {
                const isHypnos = state.session === 'hypnos';
                els.hypnosDurationCard.classList.toggle('hidden', !isHypnos);
                els.hypnosDurationButtons.forEach(btn => {
                    const selected = btn.dataset.duration === state.hypnosDuration;
                    btn.classList.toggle('border-medical-400', selected);
                    btn.classList.toggle('text-white', selected);
                    btn.classList.toggle('bg-medical-900/60', selected);
                });
            }

            function endProgram() {
                state.program = { active: false, id: null, stepIndex: 0, awaitingNext: false };
                state.sessionDataOverride = null;
                hideProgramOverlay();
                updateProgramStatus();
                if(!state.active) setSession(state.session);
            }

            function setHypnosDuration(key) {
                state.hypnosDuration = key;
                userPreferences.save({ hypnosDuration: key });
                applyHypnosDuration(key);
                updateHypnosDurationUI();
                if(state.session === 'hypnos' && !state.active) {
                    els.timer.textContent = formatTime(sessions.hypnos.duration);
                }
            }

            function updateHypnosDurationUI() {
                const isHypnos = state.session === 'hypnos';
                els.hypnosDurationCard.classList.toggle('hidden', !isHypnos);
                els.hypnosDurationButtons.forEach(btn => {
                    const selected = btn.dataset.duration === state.hypnosDuration;
                    btn.classList.toggle('border-medical-400', selected);
                    btn.classList.toggle('text-white', selected);
                    btn.classList.toggle('bg-medical-900/60', selected);
                });
            }

            function endProgram() {
                state.program = { active: false, id: null, stepIndex: 0, awaitingNext: false };
                state.sessionDataOverride = null;
                hideProgramOverlay();
                updateProgramStatus();
                if(!state.active) setSession(state.session);
            }

            function setHypnosDuration(key) {
                state.hypnosDuration = key;
                userPreferences.save({ hypnosDuration: key });
                applyHypnosDuration(key);
                updateHypnosDurationUI();
                if(state.session === 'hypnos' && !state.active) {
                    els.timer.textContent = formatTime(sessions.hypnos.duration);
                }
            }

            function updateHypnosDurationUI() {
                const isHypnos = state.session === 'hypnos';
                els.hypnosDurationCard.classList.toggle('hidden', !isHypnos);
                els.hypnosDurationButtons.forEach(btn => {
                    const selected = btn.dataset.duration === state.hypnosDuration;
                    btn.classList.toggle('border-medical-400', selected);
                    btn.classList.toggle('text-white', selected);
                    btn.classList.toggle('bg-medical-900/60', selected);
                });
            }

            function simulateCalibration(callback) {
                const overlay = document.getElementById('calibrationOverlay');
                const bar = document.getElementById('calibBar');
                const text = document.getElementById('calibText');
                const perc = document.getElementById('calibPercent');
                let p = 0;
                const steps = [{p: 20, t: "Loading Audio Drivers..."}, {p: 45, t: "Calibrating Oscillators..."}, {p: 70, t: "Initializing Noise Engine..."}, {p: 100, t: "System Ready."}];
                let stepIdx = 0;
                const interval = setInterval(() => {
                    p += Math.random() * 5;
                    if(p > steps[stepIdx].p) { text.textContent = steps[stepIdx].t; stepIdx++; }
                    if(p >= 100) { p = 100; clearInterval(interval); setTimeout(() => { overlay.style.opacity = 0; setTimeout(() => { overlay.style.display = 'none'; if(callback) callback(); }, 1000); }, 500); }
                    bar.style.width = p + "%"; perc.textContent = Math.floor(p) + "%";
                }, 30);
            }

            function renderModes() {
                els.modeContainer.innerHTML = '';
                Object.values(sessions).forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = `mode-btn w-full text-left p-3 rounded border transition-all duration-200 flex flex-col gap-1 group relative overflow-hidden`;
                    btn.dataset.id = s.id;
                    btn.innerHTML = `<div class="flex items-center justify-between w-full relative z-10"><div class="flex items-center gap-3"><div class="text-zinc-500 group-hover:text-medical-400 transition-colors icon-container">${s.icon}</div><span class="font-bold text-[11px] uppercase tracking-wider">${s.name}</span></div><span class="text-[9px] font-mono text-zinc-500">${s.duration === Infinity ? "∞" : Math.floor(s.duration/60) + " MIN"}</span></div>`;
                    btn.addEventListener('click', () => setSession(s.id));
                    els.modeContainer.appendChild(btn);
                });
            }

            function setSession(id, options = {}) {
                if (state.active) return;
                state.session = id;
                const overrideSeconds = options.overrideDurationSeconds ?? null;
                state.sessionDataOverride = overrideSeconds ? cloneSessionWithDuration(id, overrideSeconds) : null;
                if(!options.skipSave) userPreferences.save({ lastSessionId: id });
                const data = getSessionData();

                if(id === 'hypnos') {
                    setNoiseType('brown');
                    applyHypnosDuration(state.hypnosDuration);
                } else {
                    els.hypnosDurationCard.classList.add('hidden');
                }

                document.querySelectorAll('.mode-btn').forEach(b => {
                    const isActive = b.dataset.id === id;
                    const icon = b.querySelector('.icon-container');
                    if(isActive) {
                        b.classList.remove('border-transparent', 'text-zinc-500');
                        b.classList.add('bg-medical-900/30', 'border-medical-500/50', 'text-white', 'glow-box-cyan');
                        icon.classList.remove('text-zinc-500');
                        icon.classList.add('text-medical-400');
                    } else {
                        b.classList.add('border-transparent', 'text-zinc-500');
                        b.classList.remove('bg-medical-900/30', 'border-medical-500/50', 'text-white', 'glow-box-cyan');
                        icon.classList.add('text-zinc-500');
                        icon.classList.remove('text-medical-400');
                    }
                });
                els.messageTitle.textContent = data.name;
                els.desc.textContent = data.desc;
                els.timer.textContent = formatTime(data.duration);
                els.realtimeHz.textContent = "0.00 Hz";
                els.phaseName.textContent = "Gotowy";
                updateBreathPatternUI();
                updateHypnosDurationUI();
            }

            async function startAudio() {
                await Tone.start();

                const data = getSessionData();

                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'Kora Cortex',
                        artist: 'Bio-Entrainment System',
                        album: data.name
                    });
                    navigator.mediaSession.setActionHandler('play', toggleSession);
                    navigator.mediaSession.setActionHandler('pause', toggleSession);
                }
                const startPhase = data.phases[0];
                const startL = startPhase.audio.l || 220;
                const startR = startPhase.audio.r || 228;
                const intensity = intensityProfiles[state.intensityLevel] || intensityProfiles.medium;

                state.audio.gain = new Tone.Gain(0).toDestination();
                const pL = new Tone.Panner(-1).connect(state.audio.gain);
                const pR = new Tone.Panner(1).connect(state.audio.gain);

                state.audio.oscL = new Tone.Oscillator(startL, "sine").connect(pL).start();
                state.audio.oscR = new Tone.Oscillator(startR, "sine").connect(pR).start();

                state.audio.noiseGain = new Tone.Gain(0).toDestination();
                state.audio.noise = new Tone.Noise(state.noiseType).connect(state.audio.noiseGain).start();

                state.audio.noiseGain.gain.rampTo(0.08, 3);
                state.audio.gain.gain.rampTo(0.1 * (intensity.gain || 1), 1);
            }

            function stopAudio() {
                if (state.audio.oscL) { state.audio.oscL.dispose(); state.audio.oscL = null; }
                if (state.audio.oscR) { state.audio.oscR.dispose(); state.audio.oscR = null; }
                if (state.audio.gain) { state.audio.gain.dispose(); state.audio.gain = null; }
                if (state.audio.noise) { state.audio.noise.dispose(); state.audio.noise = null; }
                if (state.audio.noiseGain) { state.audio.noiseGain.dispose(); state.audio.noiseGain = null; }
            }

            function updateAudio(phase, progress, t) {
                if (!state.audio.gain || !state.audio.oscL || !state.audio.oscR) return;
                const a = phase.audio || {};
                if (a.l) state.audio.oscL.frequency.value = a.l;
                if (a.r) state.audio.oscR.frequency.value = a.r;

                const intensity = intensityProfiles[state.intensityLevel] || intensityProfiles.medium;

                const currentHz = Math.abs(state.audio.oscL.frequency.value - state.audio.oscR.frequency.value);
                const displayHz = (currentHz + (Math.random() * 0.05 - 0.025)).toFixed(2);
                els.realtimeHz.textContent = `${displayHz} Hz`;

                let vol = 0.2;
                if(a.vol !== undefined) vol = a.vol;
                else if(a.vol_s !== undefined && a.vol_e !== undefined) {
                    vol = (progress === undefined || isNaN(progress)) ? a.vol_s : lerp(a.vol_s, a.vol_e, progress);
                }

                vol = vol * (intensity.gain || 1);

                const rampFactor = 1 - (state.hypnosRampProgress * 0.9);
                vol = Math.max(0, vol * rampFactor);

                if (a.mod === 'iso') {
                    const rate = 2;
                    const mod = (Math.sin(t * Math.PI * 2 * rate) + 1) / 2;
                    state.audio.gain.gain.value = vol * mod;
                } else {
                    state.audio.gain.gain.value = vol;
                }

                const deltaFactor = intensity.delta || 1;
                if(deltaFactor !== 1) {
                    const l = state.audio.oscL.frequency.value;
                    const r = state.audio.oscR.frequency.value;
                    const center = (l + r) / 2;
                    const diff = ((r - l) / 2) * deltaFactor;
                    state.audio.oscL.frequency.value = center - diff;
                    state.audio.oscR.frequency.value = center + diff;
                }
            }

            // Smooth Hypnos ramp-down before auto-stop
            function startHypnosRampDown() {
                if(state.hypnosRampTimer || !state.active) return;
                const startGain = state.audio.gain?.gain.value ?? 0;
                const startNoise = state.audio.noiseGain?.gain.value ?? 0;
                state.hypnosRampProgress = 0;
                state.hypnosRampTimer = setInterval(() => {
                    state.hypnosRampProgress = Math.min(1, state.hypnosRampProgress + 0.1);
                    if(state.audio.gain) state.audio.gain.gain.rampTo(startGain * (1 - state.hypnosRampProgress), 0.3);
                    if(state.audio.noiseGain) state.audio.noiseGain.gain.rampTo(startNoise * (1 - state.hypnosRampProgress), 0.3);
                    if(state.hypnosRampProgress >= 1) {
                        clearInterval(state.hypnosRampTimer);
                        state.hypnosRampTimer = null;
                        toggleSession('auto-complete');
                    }
                }, 700);
            }

            async function playTestTone(pan) {
                await Tone.start();
                const synth = new Tone.Synth().toDestination();
                const panner = new Tone.Panner(pan).toDestination();
                synth.connect(panner);
                synth.triggerAttackRelease("C5", "0.2");
            }

            function initCanvas() {
                state.ctx = els.canvas.getContext('2d');
                resizeCanvas();
            }

            function resizeCanvas() {
                const container = els.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                els.canvas.width = rect.width;
                els.canvas.height = rect.height;
            }

            function drawVisual(phase, progress, t) {
                const ctx = state.ctx;
                const w = els.canvas.width;
                const h = els.canvas.height;
                const v = phase.visual || { f: 1, mod: 'soft', bri: 0.5 };

                if(state.audioOnly) {
                    const grad = ctx.createLinearGradient(0, 0, 0, h);
                    grad.addColorStop(0, 'rgba(10,10,12,0.95)');
                    grad.addColorStop(1, 'rgba(5,5,7,0.98)');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, w, h);
                    return;
                }

                // HYPNOS BLACKOUT LOGIC
                let isHypnos = state.session === 'hypnos';

                let freq = v.f;
                if (v.f_s && v.f_e && !isNaN(progress)) freq = lerp(v.f_s, v.f_e, progress);

                let modType = v.mod;
                let safeBrightnessCap = 1;
                if(state.safeVisuals) {
                    freq = Math.min(freq, state.session === 'overdrive' ? 12 : 10);
                    modType = modType === 'hard' ? 'soft' : modType;
                    safeBrightnessCap = state.session === 'overdrive' ? 0.6 : 0.5;
                }

                const pulseRaw = Math.sin(t * Math.PI * 2 * freq);
                const pulse = (pulseRaw + 1) / 2;

                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, w, h);

                let bri = v.bri || 0.8;
                if (isHypnos && state.active) {
                    bri = bri * 0.05; // Ultra dim for sleep
                }

                if (modType === 'breath') bri = bri * (0.6 + 0.4 * pulse);
                else if (modType === 'soft') bri = bri * (0.8 + 0.2 * pulse);
                else if (modType === 'hard') bri = pulseRaw > 0 ? 1 : 0;

                bri = bri * (1 - state.hypnosRampProgress * 0.8);
                bri = Math.min(bri, safeBrightnessCap);

                if (bri > 0.001) {
                    const maxR = Math.sqrt(w*w + h*h) * 0.6;
                    const grad = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, maxR);
                    const cVal = Math.floor(bri * 255);
                    grad.addColorStop(0, `rgba(${cVal}, ${cVal}, ${cVal + 20}, 1)`);
                    grad.addColorStop(1, 'rgba(0,0,0,1)');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, w, h);
                }

                // Only draw oscilloscope if NOT in Hypnos mode
                if (!isHypnos) {
                    ctx.beginPath();
                    ctx.lineWidth = state.safeVisuals ? 1.2 : 2;
                    ctx.strokeStyle = `rgba(34, 211, 238, ${0.5 + bri*0.5})`;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#22d3ee';
                    const amplitude = h * 0.15 * (state.safeVisuals ? 0.6 : 1);
                    const centerY = h / 2;
                    for(let x=0; x<w; x+=2) {
                        const y = centerY + Math.sin((x + t * 100) * 0.02) * amplitude * bri + Math.sin((x - t * 50) * 0.05) * (amplitude/2);
                        if(x===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }

                if (state.breathingPacer) {
                    // Hide pacer in Hypnos to avoid light
                    if (!isHypnos || !state.active) {
                        const patternId = resolveBreathPattern();
                        const preset = breathPatterns[patternId] || breathPatterns['4-6'];
                        const sequence = preset.sequence || breathPatterns['4-6'].sequence;
                        const totalDuration = sequence.reduce((acc, step) => acc + step.duration, 0) || 10;
                        const cycleT = t % totalDuration;
                        let breathProgress = 0;
                        let breathLabel = "";
                        let elapsed = 0;
                        let currentLevel = 0;

                        for (const step of sequence) {
                            const start = elapsed;
                            const end = elapsed + step.duration;
                            const targetLevel = step.label === 'IN' ? 1 : step.label === 'OUT' ? 0 : currentLevel;

                            if (cycleT >= start && cycleT < end) {
                                const localP = (cycleT - start) / step.duration;
                                if (targetLevel > currentLevel) {
                                    breathProgress = currentLevel + (1 - Math.pow(1 - localP, 3)) * (targetLevel - currentLevel);
                                } else if (targetLevel < currentLevel) {
                                    breathProgress = currentLevel - Math.pow(localP, 3) * (currentLevel - targetLevel);
                                } else {
                                    breathProgress = currentLevel;
                                }
                                breathLabel = step.label;
                                break;
                            }

                            currentLevel = targetLevel;
                            elapsed = end;
                        }

                        if (!breathLabel) {
                            breathLabel = sequence[sequence.length - 1]?.label || 'HOLD';
                            breathProgress = currentLevel;
                        }

                        const baseR = Math.min(w, h) * 0.2;
                        const maxR = Math.min(w, h) * 0.35;
                        const currentR = baseR + (maxR - baseR) * breathProgress;
                        ctx.beginPath();
                        ctx.arc(w/2, h/2, currentR, 0, Math.PI * 2);
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = `rgba(34, 211, 238, 0.5)`;
                        ctx.stroke();
                        ctx.fillStyle = `rgba(34, 211, 238, ${0.05 + 0.1 * breathProgress})`;
                        ctx.fill();
                        ctx.font = "12px JetBrains Mono";
                        ctx.fillStyle = `rgba(34, 211, 238, 0.9)`;
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText(breathLabel, w/2, h/2);
                    }
                }
            }

            async function toggleSession(reason = 'manual') {
                if (state.active) {
                    state.active = false;
                    if(state.hypnosRampTimer) { clearInterval(state.hypnosRampTimer); state.hypnosRampTimer = null; }
                    state.hypnosRampProgress = 0;
                    stopAudio();
                    els.canvas.style.opacity = 0;
                    els.msgBox.style.opacity = 1;
                    els.msgBox.style.transform = "scale(1)";
                    els.mainBtn.textContent = "URUCHOM";
                    els.mainBtn.classList.remove('bg-medical-400', 'text-black', 'shadow-[0_0_20px_rgba(34,211,238,0.4)]');
                    els.mainBtn.classList.add('bg-zinc-100', 'text-black', 'shadow-[0_0_20px_rgba(255,255,255,0.05)]');
                    els.controlPanel.classList.remove('glow-box-cyan');
                    els.timer.classList.remove('glow-text-cyan');
                    els.statusText.textContent = "Standby";
                    els.statusDot.className = "w-1.5 h-1.5 rounded-full bg-zinc-600";
                    els.statusDot.style.boxShadow = 'none';

                    els.appHeader.style.opacity = '1';
                    els.leftPanel.style.opacity = '1';
                    els.controlPanel.style.opacity = '1';
                    els.appFooter.style.opacity = '1';

                    disableFocusLock();
                    setSession(state.session);
                    handleProgramAfterStep();
                } else {
                    await startAudio();
                    state.active = true;
                    state.startTime = performance.now();
                    state.hypnosRampProgress = 0;
                    state.lastInteraction = performance.now();
                    els.canvas.style.opacity = 1;
                    els.msgBox.style.opacity = 0;
                    els.msgBox.style.transform = "scale(0.95)";
                    els.mainBtn.textContent = "ZATRZYMAJ";
                    els.mainBtn.classList.remove('bg-zinc-100', 'shadow-[0_0_20px_rgba(255,255,255,0.05)]');
                    els.mainBtn.classList.add('bg-medical-400', 'shadow-[0_0_20px_rgba(34,211,238,0.4)]');
                    els.controlPanel.classList.add('glow-box-cyan');
                    els.timer.classList.add('glow-text-cyan');
                    els.statusText.textContent = "ACTIVE";
                    els.statusDot.className = "w-1.5 h-1.5 rounded-full bg-medical-400 animate-pulse";
                    els.statusDot.style.boxShadow = '0 0 8px #22d3ee';
                    if(state.focusLock) enableFocusLock();
                }
            }

            function togglePreview() {
                if (state.active) return;
                state.preview = !state.preview;
                els.canvas.style.opacity = state.preview ? 1 : 0;
                els.msgBox.style.opacity = state.preview ? 0 : 1;
                state.startTime = performance.now();
                if(state.preview) els.realtimeHz.textContent = "PREVIEW";
            }

            function loop() {
                const now = performance.now();

                if (state.active && state.session === 'hypnos') {
                    if (now - state.lastInteraction > 5000) {
                        els.appHeader.style.opacity = '0.1';
                        els.leftPanel.style.opacity = '0.1';
                        els.controlPanel.style.opacity = '0.1';
                        els.appFooter.style.opacity = '0';
                    }
                }

                if (state.active || state.preview) {
                    const data = getSessionData();
                    const elapsed = (now - state.startTime) / 1000;

                    if (state.active && data.duration !== Infinity) {
                        if(state.session === 'hypnos') {
                            if(elapsed >= data.duration) { startHypnosRampDown(); }
                        } else if (elapsed >= data.duration) { toggleSession('auto-complete'); return; }
                    }

                    let currentPhase = data.phases[data.phases.length-1];
                    for(let i=0; i<data.phases.length; i++) {
                        const p = data.phases[i];
                        if (elapsed >= p.start && (elapsed < p.end || p.end === Infinity)) {
                            currentPhase = p;
                            break;
                        }
                    }

                    if (state.preview) { drawVisual(data.phases[1] || data.phases[0], 0.5, elapsed); }
                    else {
                        const phaseDuration = currentPhase.end === Infinity ? 1 : (currentPhase.end - currentPhase.start);
                        const phaseProgress = currentPhase.end === Infinity ? 0 : (elapsed - currentPhase.start) / phaseDuration;

                        updateAudio(currentPhase, phaseProgress, elapsed);
                        drawVisual(currentPhase, phaseProgress, elapsed);

                        if(data.duration === Infinity) {
                            els.timer.textContent = "∞";
                            els.progressBar.style.width = "100%";
                        } else {
                            els.timer.textContent = formatTime(Math.max(0, data.duration - elapsed));
                            els.progressBar.style.width = `${(elapsed / data.duration) * 100}%`;
                        }
                        els.phaseName.textContent = currentPhase.name;
                    }
                }
                requestAnimationFrame(loop);
            }

            function formatTime(s) {
                if(s === Infinity) return "∞";
                const m = Math.floor(s / 60).toString().padStart(2,'0');
                const sec = Math.floor(s % 60).toString().padStart(2,'0');
                return `${m}:${sec}`;
            }
            function lerp(a, b, t) { return a + (b - a) * t; }
            function enableFocusLock() { document.documentElement.requestFullscreen().catch(()=>{}); document.addEventListener('keydown', lockKey); }
            function disableFocusLock() { if(document.fullscreenElement) document.exitFullscreen().catch(()=>{}); document.removeEventListener('keydown', lockKey); }
            function lockKey(e) { if(e.key === 'Escape') { e.preventDefault(); toggleSession(); } }
            function toggleFullscreen() {
                const el = document.getElementById('visualizer');
                if(!document.fullscreenElement && !document.webkitFullscreenElement) {
                    if(el.requestFullscreen) el.requestFullscreen();
                    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                } else {
                    if(document.exitFullscreen) document.exitFullscreen();
                    else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
                }
            }
            ['fullscreenchange', 'webkitfullscreenchange'].forEach(event => { document.addEventListener(event, () => { setTimeout(resizeCanvas, 100); }); });
            init();
        </script>
    </body>
</html>
